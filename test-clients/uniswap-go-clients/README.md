# Minimalist Uniswap V3 DEX simulation

The _uniswap_sim.go_ file in this directory runs clients that setup and 
simulate a minimal Uniswap V3 DEX. The _uniswap_sim.go_ main function 
takes a single argument from the set `{setup | do-swaps | manage-liquidity}`.
We cover each choice below, after discussing how to configure and target 
the clients.

**Table of contents**
1. [Configuring the clients](#configuring-the-clients)
2. [Setting up the simulation](#setting-up-the-simulation)
3. [Running liquidity providers and traders](#running-lps-and-traders)
4. [Limitations](#limitations)

# Configuring the clients

Each client launched via _uniswap_sim.go_ will use a single payer for all its 
transactions; you set this payer by the environment variables `PAYER_ID` and 
`PAYER_KEY`. For example,
```
$ NETWORK=localhost \
  PAYER_ID="0.0.2" \
  PAYER_KEY="91132178e72057a1d7528025956fe39b0b847f200ab59b2fdd367017f3087137" \
  go run uniswap_sim.go setup
```

_TODO - what is best way to support non-named networks, e.g. perfnets?_

The [_assets/params.json_](./assets/params.json) file includes several options 
to configure the simulation clients, which we will discuss in turn below. When 
the `setup` client runs, it also writes an _assets/details.json_ file with the 
addresses and id's of the created entities. This looks like, for example,
```
{
    "lpIds": [
        "0000000000000000000000000000000000000476"
    ],
    "tickers": [
        "$ASB",
        "$FW"
    ],
    "tokenIds": [
        "0000000000000000000000000000000000000472",
        "0000000000000000000000000000000000000473"
    ],
    "traderIds": [
        "0000000000000000000000000000000000000478"
    ],
    "factoryId": "0.0.1132",
    "weth9Id": "0.0.1128"
}
```

:warning:&nbsp; The `manage-liquidity` and `do-swaps` clients **must** have an existing
_assets/details.json_ file generated by a `setup` client against the same network.
Otherwise they will not be able to do anything.

# Setting up the simulation

The _assets/params.json_ config that applies to setup includes:
  - `ercTokenNames`: Names of the ERC20 tokens to be paired in pools; ticker 
    symbols are derived from the first letters of each word in the name. 
  - `numTraders`: How many trader contracts to create (that is, instances of 
    [_assets/solidity/TypicalV3Swap.sol_](./assets/solidity/TypicalV3Swap.sol)).
  - `numLiquidityProviders`: How many LP contracts to create (that is, instances of 
    [_assets/solidity/TypicalV3LP.sol_](./assets/solidity/TypicalV3LP.sol)).
  - `numStartupMints`: How many liquidity positions to mint at the end of setup---
    all pools start with zero liquidity, so if we want to allow traders to
    start swapping right away, we need this to be greater than zero.

# Running liquidity providers and traders

Once the `setup` client has completed against a target network, we can
start running the clients to mint more liquidity and swap tokens. 

## LPs

Use `manage-liquidity` to start a client that will continuously,
  1. Choose a random liquidity provider; and,
  2. Choose a random pool; and,
  3. Mint a new liquidity position; and,
  4. Sleep before returning to (1).

The client chooses LP and pool from the available _assets/details.json_.

Parameters in _assets/params.json_ that affect this client:
  - `millisBetweenMints`: How many milliseconds to sleep between mints.
  - `gasOfferPerMint`: How much gas to offer per mint.
  - `checkMintRecords`: If `true`, specifies to synchronously get the 
     record of each mint and report its result; if `false`, specifies
     to "fire-and-forget" mint transactions.
  - `opsBetweenBalanceDisplay`: How many operations to perform before
     displaying the token balances of all LPs.

## Traders

Use `do-swaps` to start a client that will continuously,
  1. Choose a random trader; and,
  2. Choose a random pool; and,
  3. Choose at random whether to do an exact-input or exact-output swap; and,
  4. Perform the swap; and,
  5. Sleep before returning to (1).

The client chooses trader and pool from the available _assets/details.json_.

Parameters in _assets/params.json_ that affect this client:
  - `millisBetweenSwaps`: How many milliseconds to sleep between swaps.
  - `gasOfferPerSwap`: How much gas to offer per swap.
  - `checkSwapRecords`: If `true`, specifies to synchronously get the 
     record of each swap and report its result; if `false`, specifies
     to "fire-and-forget" swap transactions.
  - `opsBetweenBalanceDisplay`: How many operations to perform before
     displaying the token balances of all traders.

:information_source:&nbsp; If a trader tries to swap with a pool with insufficient 
liquidity, the result will be `CONTRACT_REVERT_EXECUTED`.  

# Limitations

Please note the following fixed assumptions:
 - Each pool is initialized with a price of 1 (that is, `sqrtPriceX96=79228162514264337594000000000`), and a pool fee of `0.05%`.
 - All liquidity positions are minted at the widest possible interval allowed
   by the chosen fee; that is, in the tick range `[-887270, +887270]`.
 - All positions are minted with an equal amount of both tokens in the pair, and all 
   swaps (both fixed-input and fixed-output) are always for the same amount.

Future versions of these clients may be more configurable.

